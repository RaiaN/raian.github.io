<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:none;color:black;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a:hover{color:orange;text-decoration:none;box-shadow:none;}</style><meta name="generator" content="Gatsby 5.7.0"/><meta data-react-helmet="true" name="description" content="Fixing camera cut bug and tuning occlusion system"/><meta data-react-helmet="true" property="og:title" content="Level Sequence Optimization Tweaks in Unreal Engine 4"/><meta data-react-helmet="true" property="og:description" content="Fixing camera cut bug and tuning occlusion system"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Petr Leontev"/><meta data-react-helmet="true" name="twitter:title" content="Level Sequence Optimization Tweaks in Unreal Engine 4"/><meta data-react-helmet="true" name="twitter:description" content="Fixing camera cut bug and tuning occlusion system"/><meta data-react-helmet="true" name="keywords" content="blog, unreal engine"/><style data-href="/styles.38c555d8219e442f87b4.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}body{background-image:url(/static/whitenoise-e7499399fb563a3fb7cd2d9c8d15c78c.png)}li{margin-bottom:0}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{margin:.5em 0;overflow:visible;padding:1px;position:relative}pre[class*=language-]>code{background-attachment:local;background-color:#fdfdfd;background-image:linear-gradient(transparent 50%,rgba(69,142,209,.04) 0);background-origin:content-box;background-size:3em 3em;border-left:10px solid #358ccb;box-shadow:-1px 0 0 0 #358ccb,0 0 0 1px #dfdfdf;position:relative;z-index:1}code[class*=language-]{display:block;height:inherit;max-height:inherit;overflow:auto;padding:0 1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdfdfd;box-sizing:border-box;margin-bottom:1em}:not(pre)>code[class*=language-]{border:1px solid rgba(0,0,0,.1);border-radius:.3em;color:#c92c2c;display:inline;padding:.2em;position:relative;white-space:normal}pre[class*=language-]:after,pre[class*=language-]:before{bottom:.75em;box-shadow:0 13px 8px #979797;content:"";display:block;height:20%;left:.18em;max-height:13em;position:absolute;transform:rotate(-2deg);width:40%}pre[class*=language-]:after{left:auto;right:.75em;transform:rotate(2deg)}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7d8b99}.token.punctuation{color:#5f6364}.token.boolean,.token.constant,.token.deleted,.token.function-name,.token.number,.token.property,.token.symbol,.token.tag{color:#c92c2c}.token.attr-name,.token.builtin,.token.char,.token.function,.token.inserted,.token.selector,.token.string{color:#2f9c0a}.token.entity,.token.operator,.token.url,.token.variable{background:hsla(0,0%,100%,.5);color:#a67f59}.token.atrule,.token.attr-value,.token.class-name,.token.keyword{color:#1990b8}.token.important,.token.regex{color:#e90}.language-css .token.string,.style .token.string{background:hsla(0,0%,100%,.5);color:#a67f59}.token.important{font-weight:400}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.7}@media screen and (max-width:767px){pre[class*=language-]:after,pre[class*=language-]:before{bottom:14px;box-shadow:none}}pre[class*=language-].line-numbers.line-numbers{padding-left:0}pre[class*=language-].line-numbers.line-numbers code{padding-left:3.8em}pre[class*=language-].line-numbers.line-numbers .line-numbers-rows{left:0}pre[class*=language-][data-line]{padding-bottom:0;padding-left:0;padding-top:0}pre[data-line] code{padding-left:4em;position:relative}pre .line-highlight{margin-top:0}</style><title data-react-helmet="true" class="jsx-679949698">Petr Leontev - Tech Entrepreneur &amp; Unreal Engineer  | Level Sequence Optimization Tweaks in Unreal Engine 4</title><link data-react-helmet="true" rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsSAAALEgHS3X78AAAAB3RJTUUH4wQWCTow0Fe4VQAAASBJREFUaN7t101Kw0AYh/FfStwKeoHi2rUg0r2C4N4DuPAo4gk8h4eQIq5EN34dQBfa7vwgbiKUodCS1jQD7wMhvIF/kifMvJkhCIIgCDKmSOpqjkyFEd7xgCEu6/O8VDPeozHVAsc1dho+RxcEKnzipEsC0+hhEwOcY5xkvnHQZYGULdwluSeUuQj8SYyS7HEbAr0lib/gIrm2v4q2usiXGSTZ+5yGkHpiT2bfchMop7TUbOYArCf1RxtjfpkC20n9mpvAUVIPc+pC/VX9B5Zx4z5uk9wz1roqUGADezirJ+tk5geHua5Gv3Ca63L6Brtt7wfKhpLjekf2OLEju1pF15klUOg4PZkTAiEQAiEQAv/6I2tzGR9DKAiCIAiy4xcOsNjd4974mwAAAABJRU5ErkJggg==" class="jsx-679949698"/><style id="__jsx-580389387">li.jsx-580389387{display:inline-block;margin-right:0em;margin-left:1em;}@media (max-width:500px){li.jsx-580389387{display:inline-block;margin-right:1em;margin-left:0em;}}</style><style id="__jsx-998478337">li.jsx-998478337{display:inline-block;margin-right:0em;margin-left:1em;}@media (max-width:500px){li.jsx-998478337{display:inline-block;margin-right:1em;margin-left:0em;}}</style><style id="__jsx-679949698">.layout-container.jsx-679949698{margin:2rem auto;max-width:900px;padding:1rem;}.layout-header.jsx-679949698{margin-left:0px;margin-bottom:16vm;display:inline;}.author.jsx-679949698{display:inline;}.navigation.jsx-679949698{float:right;margin-bottom:0;display:inline-block;}.layout-content.jsx-679949698{margin-top:2.5em;}@media (max-width:500px){.author.jsx-679949698{margin-top:0px;margin-bottom:1px;display:block;}.navigation.jsx-679949698{margin-left:0px;float:none;}.layout-content.jsx-679949698{margin-top:0.5em;}}</style><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="jsx-679949698 layout-container"><header class="jsx-679949698 layout-header"><a href="/"><h2 class="jsx-679949698 author">Petr Leontev</h2></a><ul class="jsx-679949698 navigation"><li class="jsx-580389387"><a href="/about/"><b class="jsx-679949698">About</b></a></li><li class="jsx-580389387"><a href="/"><b class="jsx-679949698">Blog</b></a></li><li class="jsx-998478337"><a href="/static/petr_leontev_cv_sa-2d981d9dfd938591a3bc96007ee26514.pdf" target="_blank" rel="noopener noreferrer" class="jsx-998478337"><b class="jsx-998478337">CV</b></a></li></ul></header><div class="jsx-679949698 layout-content"><a href="/"><h3 style="margin:0;margin-bottom:3.5rem">Blog</h3></a><div><main><h4 style="margin-bottom:7px;margin-top:0"><i>Level Sequence Optimization Tweaks in Unreal Engine 4</i></h4><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:0.58333rem;margin-top:0">September 20, 2020</p><p><strong>Intro</strong></p>
<p>Unreal Engine 4 Level Sequence provides a great way to make in-game cinematics with ease. However, results sometimes are not desireable performance-wise. There are different reasons why this might happen, for example, high quality content, a lot of visible primitives in player frustrum but that is not all. Lets start look at facts that pop up during profiling.</p>
<p><strong>The history of the bug</strong></p>
<p>Lets look at a very simple test scene with a plane, 1000 static mesh objects placed behind it and no lighting actors (only HDRI backdrop). Expected behaviour is that the engine will occlusion cull 1000 static meshes as they are located begind the plane.</p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f71e0b1af659926ef5cf57b031b27964/29114/occlusion_culling_test_scene.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACRklEQVR42mNgYmJiZmZmYGBgYWFhhQEWFmZmFmYeHl4pKRlpaRl+fgGIGkZGRgYwgDOgrKjIqMmTJ3d3d/X29vZPmNQ/YeL8BQt37tq7e8++JUuXTZ4ydfKUqQ31DbW1daVlZdzc3FDNEFMTEhIOHjiwecuWbbsO7N6zb/+e/bt37t62ZevWzVu2bt+6c9fOo0ePXb16fdfOXVOmTGFlZUXR7OHhsX379k1bd23avHXb5q0bt2/cumPrjh07tu/Yvm/T3u0bt69evXrv3n0PHjwqLS1FuJyJiYmBgcHIyGjPvoPbd+/ZuXFH0+lW20fOAXdDI25He90LqDlTP3//gi1btyxbtuzx4ycTJkyA64KaIS8nv2P/0a1btm3Ysd7joY/sGxWlNxomLywC74eovNI2fGrRcqp11eqVR44cvX7jloiICEqASUjJ7D9+dufWXZt2ba28Vpd0LzP9bm7ZzZr1hzdPODM1/3rp5FPTt23bsXLlqncfvoSEhkM1QxxgYGQyefrU3gkNq9fPXbJu2uL1k5aun7Ji3dRlK6ctXzJr8eJpM+b0dU1o9Al23bX/UHtnLwMy4ODg9A1xb56c2DIjtmVKfMfUhM5pye3TEhonRdb2xdT3JVR2RObUBAWnWAfG+ienZSF0Ql0uLdranzV9fvHk6UVTZ1T2TS9vmpTVMCmprCuiuC20uieitj+ytDXU1s1UQkoaxWaIfnFJ4bgk95bOtI6JebV9mTXdSQ0Toss6wuOK3MNTnJLy3Kzsdbl5eSB6AIkz+qR3nGv+AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Occluded objects being rendered by using console command r.VisualizeOccludedPrimitives = 1"
        title=""
        src="/static/f71e0b1af659926ef5cf57b031b27964/c1b63/occlusion_culling_test_scene.png"
        srcset="/static/f71e0b1af659926ef5cf57b031b27964/5a46d/occlusion_culling_test_scene.png 300w,
/static/f71e0b1af659926ef5cf57b031b27964/0a47e/occlusion_culling_test_scene.png 600w,
/static/f71e0b1af659926ef5cf57b031b27964/c1b63/occlusion_culling_test_scene.png 1200w,
/static/f71e0b1af659926ef5cf57b031b27964/d61c2/occlusion_culling_test_scene.png 1800w,
/static/f71e0b1af659926ef5cf57b031b27964/29114/occlusion_culling_test_scene.png 1920w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<p>Now lets create a very simple level sequence where camera switches from game to sequence one and back but its position, rotation and other view parameters are not changed.</p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/1c484c97f49b9199580cc03838a51d18/29114/level_sequence_example.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABLUlEQVR42tWQSXaCQBRFWQ5QzS9ADJRUY0ARiQN6VJKc5GSS/W8gB4hRlpB77uQ3b/KMrDlVdVu3fdX2fX8+ZQkwhwFNkziJ463W+/3OGTcwCwCMsbXvh0FgJHotA9ChM6s2HjhgYbt7bd6+hmaoP78/HI8hijGQPxHFiGLjvdDnPGjTVXfw+8OqfeGrRHu7bXypnocmHtrtpXrKEidWbqLv7kYNHulwoSKEYkyElEoqKZWSCijYNkIIP4oxNsb7g1IISikhREghbzAANL8vMeQS8U/CaomUEgAopWNdNxzG5jCZuIejKOKcbyY452EYWqZlmiYfp1+AUnuq27LGE7phpGnadd0wDNfrteu6uq6zLDsej2VVlmVZFEWe52vf9yaEEFprxpjrup7n/QDYkJOg2nonEgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Example of level sequence"
        title=""
        src="/static/1c484c97f49b9199580cc03838a51d18/c1b63/level_sequence_example.png"
        srcset="/static/1c484c97f49b9199580cc03838a51d18/5a46d/level_sequence_example.png 300w,
/static/1c484c97f49b9199580cc03838a51d18/0a47e/level_sequence_example.png 600w,
/static/1c484c97f49b9199580cc03838a51d18/c1b63/level_sequence_example.png 1200w,
/static/1c484c97f49b9199580cc03838a51d18/d61c2/level_sequence_example.png 1800w,
/static/1c484c97f49b9199580cc03838a51d18/29114/level_sequence_example.png 1920w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<p>Although one expects nothing bad should happen (right?) <em>there is an issue</em>. Lets look at the image below to get more insights.</p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/7d3515dc18b44ceb0280188d1f579f3b/29114/profiling_stats_1.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB7ElEQVR42n3My04TYRjG8Y/QG4CwYAEkLFqWZUqbdqZDZ2hITdqZgR5nSg+k0zl957Gm7bQbE924NHoL7sSlrjQauQkjTYp3YgDFxIj//PLunheUtZNavaWqai6Xzcv5tpZWFCmTyyWF5H5q/yGCIKTTaeAO/GdPn8+jaD6dQ4qhU+30LMsy62aj3m6YzVrLrDetPxpmrdNvj0dPQsaAqiiVctm2bT5iiAUOCiAJIPERDRCBGCKM/kYwZpQSjEG5op0Pho7jhiFnlISccko5p5xRduPBMMagXS29mHvTEcGE/or8b3MXpRQhBAytYlQeYQTD8DFjjHNOMCPk5gX5d5gQwhgnhIJyxTg5rfneMPAGrud4rh2NWRRNptPxLJpEs8lsNr01ub9RNEHIHw4HQNMMTTfOu02nX682Wt2uCc+NTr971ut1+j3bdSDBXuB7ge9D3/V9RDDEaDC0TcsCum4YhiGrR6JyJBUOJUXNyIVsPp/NyxlJUo6Pi6VSWhTvZERRPCxIhUJOlmVVBbqmF3X9dSK+XF//trJyBcACgKvfFreuV1eXsdh1LLYE4Pva2mJz88fGxuXuLqieVs9s+1WxeKmqHyXpqyB8SaU+C8K9T8nku52di+3tt1tb7+PxDwcHbxKJi0Ti5d7eT/lB7JsW8zGYAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Profiling stats, render thread hitches"
        title=""
        src="/static/7d3515dc18b44ceb0280188d1f579f3b/c1b63/profiling_stats_1.png"
        srcset="/static/7d3515dc18b44ceb0280188d1f579f3b/5a46d/profiling_stats_1.png 300w,
/static/7d3515dc18b44ceb0280188d1f579f3b/0a47e/profiling_stats_1.png 600w,
/static/7d3515dc18b44ceb0280188d1f579f3b/c1b63/profiling_stats_1.png 1200w,
/static/7d3515dc18b44ceb0280188d1f579f3b/d61c2/profiling_stats_1.png 1800w,
/static/7d3515dc18b44ceb0280188d1f579f3b/29114/profiling_stats_1.png 1920w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<p>Profiling stats indicate that two render thread hitches are present and what is important that is exactly the number of times camera switches when playing the level sequence. Looking more at stats it seems that render thread hitches caused by <em>~50ms occlusion cull</em>... which is strange as camera transform didn&#x27;t change at all! Lets add <em>Occluded primitives</em> graph to the image.</p>
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/0ed344b78fb207cf9fe7d0840459fece/0f98f/profiling_stats_2.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAc8qrNOEh//EABkQAQACAwAAAAAAAAAAAAAAAAEAERASIf/aAAgBAQABBQIpNSUSuOP/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwGI/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAExIP/aAAgBAQAGPwIhFj//xAAaEAACAgMAAAAAAAAAAAAAAAAAEQEhEFFh/9oACAEBAAE/IdIcQkESiEVj/9oADAMBAAIAAwAAABAjL//EABcRAQEBAQAAAAAAAAAAAAAAAAEAEXH/2gAIAQMBAT8QCm7d3//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/EKr/xAAcEAEBAAEFAQAAAAAAAAAAAAABABEhMUGRofD/2gAIAQEAAT8QAMieXAX2k6bwIdt0JATgUA6v/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Profilig stats, number of occluded primitives drops to 0"
        title=""
        src="/static/0ed344b78fb207cf9fe7d0840459fece/e5166/profiling_stats_2.jpg"
        srcset="/static/0ed344b78fb207cf9fe7d0840459fece/f93b5/profiling_stats_2.jpg 300w,
/static/0ed344b78fb207cf9fe7d0840459fece/b4294/profiling_stats_2.jpg 600w,
/static/0ed344b78fb207cf9fe7d0840459fece/e5166/profiling_stats_2.jpg 1200w,
/static/0ed344b78fb207cf9fe7d0840459fece/d9c39/profiling_stats_2.jpg 1800w,
/static/0ed344b78fb207cf9fe7d0840459fece/0f98f/profiling_stats_2.jpg 1920w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span>
<p>In turns out that zero objects being occluded when camera switches from a game to cinematic one and back. <em>As a result the engine renders all 1000 static meshes objects behind the plane</em>. Really bad, right? Lets dive into the engine code.</p>
<p><strong>Chasing root cause of the bug</strong></p>
<p>Go to SceneVisibility.cpp function called <em>FetchVisibilityForPrimitives_Range</em>:</p>
<pre><code class="language-cpp">static void FetchVisibilityForPrimitives_Range(FVisForPrimParams&amp; Params, FGlobalDynamicVertexBuffer* DynamicVertexBufferIfSingleThreaded)
</code></pre>
<p>One branch of the function above can make the engine renderer completely ignore occlusion history for primitives:</p>
<pre><code class="language-cpp">if (View.bIgnoreExistingQueries)
{
    // If the view is ignoring occlusion queries, the primitive is definitely unoccluded.
    // already set bIsOccluded = false;
    bOcclusionStateIsDefinite = View.bDisableQuerySubmissions;
}
</code></pre>
<p><em>bIgnoreExistingQueries</em> can be set to <em>true</em> only during <em>FSceneRenderer::PreVisibilityFrameSetup(...)</em> execution:</p>
<pre><code class="language-cpp">// HighResScreenshot should get best results so we don&#x27;t do the occlusion optimization based on the former frame
extern bool GIsHighResScreenshot;
const bool bIsHitTesting = ViewFamily.EngineShowFlags.HitProxies;
// Don&#x27;t test occlusion queries in collision viewmode as they can be bigger then the rendering bounds.
const bool bCollisionView = ViewFamily.EngineShowFlags.CollisionVisibility || ViewFamily.EngineShowFlags.CollisionPawn;
if (GIsHighResScreenshot || !DoOcclusionQueries(FeatureLevel) || bIsHitTesting || bCollisionView)
{
    View.bDisableQuerySubmissions = true;
    View.bIgnoreExistingQueries = true;
}

// ...
const float DeltaTime = View.Family-&gt;CurrentRealTime - ViewState-&gt;LastRenderTime;
const bool bFirstFrameOrTimeWasReset = DeltaTime &lt; -0.0001f || ViewState-&gt;LastRenderTime &lt; 0.0001f;
// ...
// detect conditions where we should reset occlusion queries
if (bFirstFrameOrTimeWasReset ||
    ViewState-&gt;LastRenderTime + GEngine-&gt;PrimitiveProbablyVisibleTime &lt; View.Family-&gt;CurrentRealTime ||
    View.bCameraCut ||
    View.bForceCameraVisibilityReset ||
    IsLargeCameraMovement(
        View,
        ViewState-&gt;PrevViewMatrixForOcclusionQuery,
        ViewState-&gt;PrevViewOriginForOcclusionQuery,
        GEngine-&gt;CameraRotationThreshold, GEngine-&gt;CameraTranslationThreshold))
{
    View.bIgnoreExistingQueries = true;
    View.bDisableDistanceBasedFadeTransitions = true;
}
</code></pre>
<p>The first set of conditions is not related to the bug since making high resolution screenshots, occlusion queries mechanism being disabled, performing hit testing or drawing collision do not happen when playing the level sequence.</p>
<p>The second set is more interesting though as it covers the following conditions:</p>
<ol>
<li>The first frame OR the time was reset</li>
</ol>
<pre><code class="language-cpp">bFirstFrameOrTimeWasReset
</code></pre>
<ol start="2">
<li>Primitive is not visible anymore</li>
</ol>
<pre><code class="language-cpp">ViewState-&gt;LastRenderTime + GEngine-&gt;PrimitiveProbablyVisibleTime &lt; View.Family-&gt;CurrentRealTime

// The amount of time a primitive is considered to be probably visible after it was last actually visible.
UPROPERTY(config)
float PrimitiveProbablyVisibleTime;

// Clear primitives which haven&#x27;t been visible recently out of the occlusion history, and reset old pending occlusion queries.
ViewState-&gt;TrimOcclusionHistory(ViewFamily.CurrentRealTime, ViewFamily.CurrentRealTime - GEngine-&gt;PrimitiveProbablyVisibleTime, ViewFamily.CurrentRealTime, ViewState-&gt;OcclusionFrameCounter);
</code></pre>
<ol start="3">
<li>Camera cut</li>
</ol>
<pre><code class="language-cpp">/** Whether we did a camera cut for this view this frame. */
View.bCameraCut

// Was there a camera cut this frame?
ViewInitOptions.bInCameraCut = PlayerController-&gt;PlayerCameraManager-&gt;bGameCameraCutThisFrame;
</code></pre>
<ol start="4">
<li>Movie pipeline rendering (deferred passes):</li>
</ol>
<pre><code class="language-cpp">View.bForceCameraVisibilityReset

// Object Occlusion/Histories
{
    // If we&#x27;re using tiling, we force the reset of histories each frame so that we don&#x27;t use the previous tile&#x27;s
    // object occlusion queries, as that causes things to disappear from some views.
    if(InSampleState.GetTileCount() &gt; 1)
    {
        View-&gt;bForceCameraVisibilityReset = true;
    }
}
</code></pre>
<ol start="5">
<li>Large camera movement</li>
</ol>
<pre><code class="language-cpp">IsLargeCameraMovement(View, ViewState-&gt;PrevViewMatrixForOcclusionQuery, ViewState-&gt;PrevViewOriginForOcclusionQuery, GEngine-&gt;CameraRotationThreshold, GEngine-&gt;CameraTranslationThreshold)

/**
 * Helper for InitViews to detect large camera movement, in both angle and position.
 */
static bool IsLargeCameraMovement(FSceneView&amp; View, const FMatrix&amp; PrevViewMatrix, const FVector&amp; PrevViewOrigin, float CameraRotationThreshold, float CameraTranslationThreshold)
{
	float RotationThreshold = FMath::Cos(FMath::DegreesToRadians(CameraRotationThreshold));
	float ViewRightAngle = View.ViewMatrices.GetViewMatrix().GetColumn(0) | PrevViewMatrix.GetColumn(0);
	float ViewUpAngle = View.ViewMatrices.GetViewMatrix().GetColumn(1) | PrevViewMatrix.GetColumn(1);
	float ViewDirectionAngle = View.ViewMatrices.GetViewMatrix().GetColumn(2) | PrevViewMatrix.GetColumn(2);

	FVector Distance = FVector(View.ViewMatrices.GetViewOrigin()) - PrevViewOrigin;
	return
		ViewRightAngle &lt; RotationThreshold ||
		ViewUpAngle &lt; RotationThreshold ||
		ViewDirectionAngle &lt; RotationThreshold ||
		Distance.SizeSquared() &gt; CameraTranslationThreshold * CameraTranslationThreshold;
}
</code></pre>
<p>To figure out what causes <em>bIgnoreExistingQueries</em> to be true more stats have been added to <em>FSceneRenderer::PreVisibilityFrameSetup(...)</em>. It turns out that <em>View.bCameraCut = true</em> when level sequence both starts and ends.</p>
<p>Lets look at the corresponding code again:</p>
<pre><code class="language-cpp">// Was there a camera cut this frame?
ViewInitOptions.bInCameraCut = PlayerController-&gt;PlayerCameraManager-&gt;bGameCameraCutThisFrame;

// True if we did a camera cut this frame. Automatically reset to false every frame.
// This flag affects various things in the renderer (such as whether to use the occlusion queries from last frame, and motion blur).
UPROPERTY(Transient, BlueprintReadOnly, Category=PlayerCameraManager)
uint32 bGameCameraCutThisFrame : 1;

//Sets the bGameCameraCutThisFrame flag to true (indicating we did a camera cut this frame; useful for game code to call, e.g., when performing a teleport that should be seamless) */
UFUNCTION(BlueprintCallable, Category = &quot;Camera&quot;)
void SetGameCameraCutThisFrame() { bGameCameraCutThisFrame = true; }
</code></pre>
<p>There are many places in code where <em>SetGameCameraCutThisFrame()</em> is called:</p>
<pre><code class="language-cpp">D:\Unreal Engine\UE_4.25\Engine\Source\Developer\FunctionalTesting\Private\ScreenshotFunctionalTest.cpp(50):			PlayerController-&gt;PlayerCameraManager-&gt;SetGameCameraCutThisFrame();
D:\Unreal Engine\UE_4.25\Engine\Source\Editor\Sequencer\Private\Sequencer.cpp(3463):				PC-&gt;PlayerCameraManager-&gt;SetGameCameraCutThisFrame();
D:\Unreal Engine\UE_4.25\Engine\Source\Editor\Sequencer\Private\Sequencer.cpp(3507):		PC-&gt;PlayerCameraManager-&gt;SetGameCameraCutThisFrame();
D:\Unreal Engine\UE_4.25\Engine\Source\Runtime\Engine\Classes\Camera\PlayerCameraManager.h(881):	void SetGameCameraCutThisFrame() { bGameCameraCutThisFrame = true; }
D:\Unreal Engine\UE_4.25\Engine\Source\Runtime\Engine\Private\Interpolation.cpp(6765):						PC-&gt;PlayerCameraManager-&gt;SetGameCameraCutThisFrame();
D:\Unreal Engine\UE_4.25\Engine\Source\Runtime\LevelSequence\Private\LevelSequencePlayer.cpp(258):				PC-&gt;PlayerCameraManager-&gt;SetGameCameraCutThisFrame();
D:\Unreal Engine\UE_4.25\Engine\Source\Runtime\LevelSequence\Private\LevelSequencePlayer.cpp(363):		PC-&gt;PlayerCameraManager-&gt;SetGameCameraCutThisFrame();
</code></pre>
<p>Last two <em>SetGameCameraCutThisFrame()</em> is what makes a drop in the number of occluded primitives to zero as it is being called from all over the place in Level sequence code.</p>
<p><strong>Fixing the bug</strong></p>
<p>There are two easy &quot;hacky&quot; approaches to resolve this issue. The first one is about completely disabling camera cuts via the level sequence player actor settings, which can be done by selecting a level sequence player actor and setting <em>bDisableCameraCuts</em> UI property to false:</p>
<pre><code class="language-cpp">// Disable camera cuts
UPROPERTY(EditAnywhere, BlueprintReadWrite, Category=&quot;Cinematic&quot;)
uint32 bDisableCameraCuts : 1;
</code></pre>
<p>The second approach, which allows more control over camera cuts, is to call <em>SetDisableCameraCuts(...)</em> that belongs to <em>UMovieSceneSequencePlayer</em> actor:</p>
<pre><code class="language-cpp">/** Set whether to disable camera cuts */
UFUNCTION(BlueprintCallable, Category=&quot;Game|Cinematic&quot;)
void SetDisableCameraCuts(bool bInDisableCameraCuts) { PlaybackSettings.bDisableCameraCuts = bInDisableCameraCuts; }
</code></pre>
<p>The result is below:
<span><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/b40ad3a3d8ce7cb05ea7098a197185a0/29114/profiling_stats_3.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB3ElEQVR42m2LXU/iQBSG+zPMaow33qksoVDq0C8bFGhpAWWJlQKlLR06M6WiTAez2exm98JkV3/zpiC7XvjmOec8bzLDNS3L/tKXdLV8XhUVMLAqsgb4c/GsVCjwxbM3Pm/4XwvlYlHguf7Vddpy5/VeoF8HendtmlG951/0xqrlKZYvtz3F9uXcPcWabmS6Fd3klJpk6JfT4TiGaRgQP0jCgMCAoCBBISYwxlFMIkQgIrnEZJaTzGIUQq5lmuOpH4RhmqYkSRaLJA9Jtjc/O8h7SRNMMHfbvXx+mmUPZPOebL8kOLdd+TgIIc4yDdu4iudRkiwwxoQQhDeTl83GGOEPEscxZ5iWZXcXC8IYfVhlK0rX2SPN2IpmqyyjjFHGsvUTZWvK1rlkGaWUMbZcLjnTbBum5U8cGDh9ZziZjuCk44xGt+7o1nW9MIwQCuB8B4QIRXEcQnjnuly7bVu2rcqyCiQNgAtQk0WgVquqWJWrQkPTDF2XKpV/aABoACiiqALAGS2z3jKgILyUy9+Pj3/s7f3c//Tr4OA9z0dHbxwe/jk9fS2VXk5OXjWNc5y7GYSPnvcbwm+DwdebG9bp3Dcay2Zzy32jMRYEl+ddnh+WSl6t5iuKL0muovwFJ3DnMQle05gAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Profilig stats, number of occluded primitives never drops to 0"
        title=""
        src="/static/b40ad3a3d8ce7cb05ea7098a197185a0/c1b63/profiling_stats_3.png"
        srcset="/static/b40ad3a3d8ce7cb05ea7098a197185a0/5a46d/profiling_stats_3.png 300w,
/static/b40ad3a3d8ce7cb05ea7098a197185a0/0a47e/profiling_stats_3.png 600w,
/static/b40ad3a3d8ce7cb05ea7098a197185a0/c1b63/profiling_stats_3.png 1200w,
/static/b40ad3a3d8ce7cb05ea7098a197185a0/d61c2/profiling_stats_3.png 1800w,
/static/b40ad3a3d8ce7cb05ea7098a197185a0/29114/profiling_stats_3.png 1920w"
        sizes="(max-width: 1200px) 100vw, 1200px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></span></p>
<p><strong>Code solution (the only one)</strong></p>
<p>As one may notice issue with number of occluded primitives is not fixed, it is just hidden by disabling camera cuts. Why? Real reason is that the engine must not ignore occlusion history if there was no large camera movement! Additionally, camera cut condition (3rd one above) must always take that into account.</p>
<p>This is how the proper solution might look like:</p>
<pre><code class="language-cpp">
const bool bIsLargeCameraMovement = IsLargeCameraMovement(
    View,
    ViewState-&gt;PrevViewMatrixForOcclusionQuery,
    ViewState-&gt;PrevViewOriginForOcclusionQuery,
    GEngine-&gt;CameraRotationThreshold, GEngine-&gt;CameraTranslationThreshold
);

// detect conditions where we should reset occlusion queries
// completely ignore camera cut condition here
if (bFirstFrameOrTimeWasReset ||
    ViewState-&gt;LastRenderTime + GEngine-&gt;PrimitiveProbablyVisibleTime &lt; View.Family-&gt;CurrentRealTime ||
    // View.bCameraCut,
    View.bForceCameraVisibilityReset ||
    bIsLargeCameraMovement)
{
    View.bIgnoreExistingQueries = true;
    View.bDisableDistanceBasedFadeTransitions = true;
}
</code></pre>
<p>Furthermore, one may think of adding a new variable to level sequence code or engine config that forces camera cut to happen ignoring <em>IsLargeCameraMovement(...)</em> condition completely.</p>
<p><strong>Bonus: more performance tweaks for level sequence</strong></p>
<p>The following engine variables give more control over occlusion culling system:</p>
<pre><code class="language-cpp">UCLASS(abstract, config=Engine, defaultconfig, transient)
class ENGINE_API UEngine
{
    // camera rotation (deg) beyond which occlusion queries are ignored from previous frame (because they are likely not valid)
    UPROPERTY(config)
    float CameraRotationThreshold;

    // camera movement beyond which occlusion queries are ignored from previous frame (because they are likely not valid)
    UPROPERTY(config)
    float CameraTranslationThreshold;

    // The amount of time a primitive is considered to be probably visible after it was last actually visible
    UPROPERTY(config)
    float PrimitiveProbablyVisibleTime;
}
</code></pre>
<p>Given spare memory resources, increasing <em>CameraRotationThreshold</em>, <em>CameraTranslationThreshold</em> and <em>PrimitiveProbablyVisibleTime</em> values might help with reducing occlusion culling time.</p>
<p>Enjoy!</p><hr style="margin-bottom:1.75rem"/><div><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0;margin-left:0"><li><a rel="prev" href="/blog/unreal_cast/">← <i>How Unreal Engine C++ Cast&lt;T&gt; function works?</i></a></li><li><a rel="next" href="/blog/efficient_construction_of_textures/"><i>Efficient and asynchronous creation of textures at runtime in Unreal Engine</i> →</a></li></ul></div><div id="disqus_thread"></div></main></div></div><footer class="jsx-679949698"><i class="jsx-679949698">© <a href="/about/">Petr Leontev</a></i></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BBXHR6HKTT"></script><script>
      window.excludeGtagPaths=[/^(?:\/preview\/(?:(?!(?:\/|^)\.).)*?)$/];
      function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='G-BBXHR6HKTT',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
      if(!(navigator.doNotTrack == "1" || window.doNotTrack == "1")) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-BBXHR6HKTT', {"optimize_id":"OPT_CONTAINER_ID","anonymize_ip":true,"cookie_expires":0,"send_page_view":false});gtag('config', 'UA-139915107-1', {"optimize_id":"OPT_CONTAINER_ID","anonymize_ip":true,"cookie_expires":0,"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/chasing_ue4_level_sequence_bug/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-7cfbcc5fc7c13cfba746.js\"],\"component---src-pages-about-js\":[\"/component---src-pages-about-js-b9dc4a8fede13993c42c.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-a65406b22031a30116f0.js\"],\"component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-c-pointers-index-mdx\":[\"/component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-c-pointers-index-mdx-339cc46b1a9d990ac2e9.js\"],\"component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-chasing-ue-4-level-sequence-bug-index-mdx\":[\"/component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-chasing-ue-4-level-sequence-bug-index-mdx-3dd332f75f801cd03ab5.js\"],\"component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-efficient-construction-of-textures-index-mdx\":[\"/component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-efficient-construction-of-textures-index-mdx-0ecc85e2355c3b947668.js\"],\"component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-level-streaming-optimization-index-mdx\":[\"/component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-level-streaming-optimization-index-mdx-59a649bf604ff920d288.js\"],\"component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-motivation-index-mdx\":[\"/component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-motivation-index-mdx-a17769377dae2e140de3.js\"],\"component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-unreal-cast-index-mdx\":[\"/component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-unreal-cast-index-mdx-b7334845df1fdb08fe8d.js\"],\"component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-unreal-video-encoding-index-mdx\":[\"/component---src-templates-blog-post-js-content-file-path-home-runner-work-raian-github-io-raian-github-io-content-blog-unreal-video-encoding-index-mdx-c928990a4f648ded1e9f.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="f2a658e3a7495d2c26ac";</script><script src="/webpack-runtime-d0b8e70c777813eca66f.js" async></script><script src="/framework-8a49599aa6ec5ce67ebe.js" async></script><script src="/app-7cfbcc5fc7c13cfba746.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>